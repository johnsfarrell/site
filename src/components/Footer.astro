---
import child_process from 'child_process'
import { GITHUB_REPO } from '../consts'

const filepath = Astro.props.filepath ?? Astro.props.file ?? ''

async function getGitFooterData(filepath: string) {
    if (!filepath) {
        console.error('No filepath provided');
        return { error: true };
    }

    try {
        const relativeFilePath = await execShellCommand(`git ls-files --full-name ${filepath}`);
        if (!relativeFilePath) {
            console.error('Filepath does not exist in the repository');
            return { error: true };
        }

        const commits = await execShellCommand(`git log -n 5 --pretty=format:'%h - %s - %cd' --date=format:'%d %b %Y' -- "${relativeFilePath}"`);
        const commitsList = (commits as string).split('\n').map(commit => commit.trim());

        return { relativeFilePath, commitsList, error: false };
    } catch (error) {
        console.error('Failed to get git data:', error);
        return { error: true };
    }
}

async function execShellCommand(cmd: string) {
    return new Promise((resolve, reject) => {
        child_process.exec(cmd, (error, stdout) => {
            if (error) {
                reject(error);
            }
            resolve(stdout.trim());
        });
    });
}

const showFooter = import.meta.env.MODE === 'production';
let footerData;

if (showFooter) {
    footerData = await getGitFooterData(filepath);
    console.log("\n", footerData);
}
---
<footer data-nosnippet>
    <div>{
        showFooter && footerData && !footerData.error
            ? <>
                <span>Recent updates:</span>
                <ul>
                  {footerData.commitsList?.map(commit => (
                    <li>{commit}</li>
                  ))}
                </ul>
              </>
            : <span>Content may be outdated or under revision. &#60;3</span>
    }</div>
</footer>
<style>
    html a {
        color: rgba(0, 0, 0, 0.50);
    }
    html a:hover {
        color: rgba(0, 0, 0, 0.66);
    }
    html footer {
        font-size: smaller;
        color: rgba(0, 0, 0, 0.33);
        line-height: 1.5;
    }
    html footer ul {
        padding-left: 20px;
    }
</style>
